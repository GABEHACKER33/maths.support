<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Support - Gaming Platform</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (keeping for auth) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a28;
            --accent-primary: #00ff88;
            --accent-secondary: #00ccff;
            --accent-danger: #ff4466;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-glow: 0 0 40px rgba(0, 255, 136, 0.15);
            --proxy-color: #8a2be2;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 255, 136, 0.03), transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(0, 204, 255, 0.03), transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        #root {
            position: relative;
            z-index: 1;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.5); }
            50% { box-shadow: 0 0 40px rgba(138, 43, 226, 0.8); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration (for auth only)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Supabase Configuration
        const SUPABASE_URL = 'https://hsmfjpetvcsgkpkwpdjr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzbWZqcGV0dmNzZ2twa3dwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDc0MzEsImV4cCI6MjA3OTMyMzQzMX0.IBiJtUJBPyjNwGowfgnlfrbHpb46C43NmYY3O9rEFqQ';

        // Initialize Firebase (for auth)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configure Google Auth Provider to restrict to kcpupils.org
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.setCustomParameters({
            hd: 'kcpupils.org'
        });

        // Games Data
        const GAMES = [
            { id: '1', title: 'Drive Mad', category: 'Racing', url: 'https://games.playtropolis.com/drive-mad-v2/', thumbnail: 'https://images.unsplash.com/photo-1511919884226-fd3cad34687c?w=400&h=300&fit=crop', color: '#ff4466' },
            { id: '2', title: 'Subway Surfers', category: 'Endless Runner', url: 'https://poki.com/en/g/subway-surfers', thumbnail: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&h=300&fit=crop', color: '#00ccff' },
            { id: '3', title: 'Tetris', category: 'Puzzle', url: 'https://tetris.com/play-tetris', thumbnail: 'https://images.unsplash.com/photo-1607853202273-797f1c22a38e?w=400&h=300&fit=crop', color: '#00ff88' },
            { id: '4', title: 'Snake', category: 'Arcade', url: 'https://playsnake.org/', thumbnail: 'https://images.unsplash.com/photo-1511512578047-dfb367046420?w=400&h=300&fit=crop', color: '#ffaa00' },
            { id: '5', title: 'Chess', category: 'Strategy', url: 'https://www.chess.com/play/computer', thumbnail: 'https://images.unsplash.com/photo-1529699211952-734e80c4d42b?w=400&h=300&fit=crop', color: '#8844ff' },
            { id: '6', title: '2048', category: 'Puzzle', url: 'https://play2048.co/', thumbnail: 'https://images.unsplash.com/photo-1611996575749-79a3a250f948?w=400&h=300&fit=crop', color: '#ff6b9d' },
            { id: '7', title: 'Minesweeper', category: 'Logic', url: 'https://minesweeper.online/', thumbnail: 'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=400&h=300&fit=crop', color: '#66ddff' },
            { id: '8', title: 'Pac-Man', category: 'Arcade', url: 'https://www.google.com/logos/2010/pacman10-i.html', thumbnail: 'https://images.unsplash.com/photo-1578303512597-81e6cc155b3e?w=400&h=300&fit=crop', color: '#ffdd00' },
        ];

        // Supabase Service Functions
        const SupabaseService = {
            // Create or update user profile
            createUserProfile: async (user) => {
                const { data, error } = await supabase
                    .from('users')
                    .upsert({
                        uid: user.uid,
                        email: user.email,
                        display_name: user.displayName,
                        photo_url: user.photoURL,
                        status: 'online',
                        current_game: null,
                        created_at: new Date().toISOString(),
                        stats: {
                            games_played: 0,
                            total_time: 0,
                            achievements: 0
                        }
                    }, {
                        onConflict: 'uid'
                    });

                if (error) throw error;
                return data;
            },

            // Update user status
            updateUserStatus: async (uid, status, currentGame = null) => {
                const { error } = await supabase
                    .from('users')
                    .update({
                        status,
                        current_game: currentGame,
                        last_seen: new Date().toISOString()
                    })
                    .eq('uid', uid);

                if (error) throw error;
            },

            // Get friends list
            getFriends: async (userId) => {
                const { data: friendships, error } = await supabase
                    .from('friends')
                    .select('friend_id')
                    .eq('user_id', userId);

                if (error) throw error;

                if (friendships.length === 0) return [];

                const friendIds = friendships.map(f => f.friend_id);
                
                const { data: friends, error: friendsError } = await supabase
                    .from('users')
                    .select('*')
                    .in('uid', friendIds);

                if (friendsError) throw friendsError;
                
                return friends.map(friend => ({
                    id: friend.uid,
                    displayName: friend.display_name,
                    email: friend.email,
                    photoURL: friend.photo_url,
                    status: friend.status,
                    currentGame: friend.current_game
                }));
            },

            // Add friend
            addFriend: async (currentUserId, friendEmail) => {
                // Find user by email
                const { data: friendData, error: findError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', friendEmail)
                    .single();

                if (findError || !friendData) {
                    throw new Error('User not found');
                }

                const friendId = friendData.uid;

                if (friendId === currentUserId) {
                    throw new Error('Cannot add yourself as a friend');
                }

                // Check if already friends
                const { data: existingFriendship, error: checkError } = await supabase
                    .from('friends')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('friend_id', friendId)
                    .single();

                if (!checkError && existingFriendship) {
                    throw new Error('Already friends');
                }

                // Add friendship (bidirectional)
                const { error: addError } = await supabase
                    .from('friends')
                    .insert([
                        { user_id: currentUserId, friend_id: friendId },
                        { user_id: friendId, friend_id: currentUserId }
                    ]);

                if (addError) throw addError;

                return {
                    id: friendId,
                    displayName: friendData.display_name,
                    email: friendData.email,
                    photoURL: friendData.photo_url,
                    status: friendData.status
                };
            },

            // Get or create conversation
            getOrCreateConversation: async (user1Id, user2Id) => {
                // Query for existing conversation
                const { data: conversations, error } = await supabase
                    .from('conversations')
                    .select('*')
                    .contains('participants', [user1Id, user2Id]);

                if (error) throw error;

                if (conversations && conversations.length > 0) {
                    return conversations[0].id;
                }

                // Create new conversation
                const { data: newConversation, error: createError } = await supabase
                    .from('conversations')
                    .insert({
                        participants: [user1Id, user2Id],
                        created_at: new Date().toISOString(),
                        last_message: null,
                        last_message_time: null
                    })
                    .select()
                    .single();

                if (createError) throw createError;
                return newConversation.id;
            },

            // Get conversations
            getConversations: async (userId) => {
                const { data: conversations, error } = await supabase
                    .from('conversations')
                    .select('*')
                    .contains('participants', [userId])
                    .order('last_message_time', { ascending: false });

                if (error) throw error;

                const conversationsWithFriends = await Promise.all(
                    conversations.map(async (conv) => {
                        const otherUserId = conv.participants.find(id => id !== userId);
                        const { data: friendData } = await supabase
                            .from('users')
                            .select('*')
                            .eq('uid', otherUserId)
                            .single();

                        return {
                            id: conv.id,
                            friendId: otherUserId,
                            friendName: friendData?.display_name || 'Unknown',
                            friendAvatar: friendData?.photo_url || '',
                            friendStatus: friendData?.status || 'offline',
                            lastMessage: conv.last_message || '',
                            timestamp: new Date(conv.last_message_time || conv.created_at),
                            unread: 0
                        };
                    })
                );

                return conversationsWithFriends;
            },

            // Get messages
            getMessages: async (conversationId) => {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversationId)
                    .order('timestamp', { ascending: true })
                    .limit(100);

                if (error) throw error;

                return messages.map(msg => ({
                    id: msg.id,
                    ...msg,
                    timestamp: new Date(msg.timestamp)
                }));
            },

            // Send message
            sendMessage: async (conversationId, senderId, text, gameInvite = null) => {
                const { error: messageError } = await supabase
                    .from('messages')
                    .insert({
                        conversation_id: conversationId,
                        sender_id: senderId,
                        text,
                        timestamp: new Date().toISOString(),
                        game_invite: gameInvite
                    });

                if (messageError) throw messageError;

                // Update conversation with last message
                const { error: updateError } = await supabase
                    .from('conversations')
                    .update({
                        last_message: text,
                        last_message_time: new Date().toISOString()
                    })
                    .eq('id', conversationId);

                if (updateError) throw updateError;
            },

            // Increment game played stat
            incrementGamePlayed: async (userId) => {
                const { data: userData, error: fetchError } = await supabase
                    .from('users')
                    .select('stats')
                    .eq('uid', userId)
                    .single();

                if (fetchError) throw fetchError;

                const newStats = {
                    ...userData.stats,
                    games_played: (userData.stats.games_played || 0) + 1
                };

                const { error: updateError } = await supabase
                    .from('users')
                    .update({ stats: newStats })
                    .eq('uid', userId);

                if (updateError) throw updateError;
            },

            // Subscribe to real-time updates
            subscribeToConversations: (userId, callback) => {
                return supabase
                    .channel('conversations')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'conversations',
                            filter: `participants=cs.{${userId}}`
                        }, 
                        async () => {
                            const conversations = await SupabaseService.getConversations(userId);
                            callback(conversations);
                        }
                    )
                    .subscribe();
            },

            subscribeToMessages: (conversationId, callback) => {
                return supabase
                    .channel('messages')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'messages',
                            filter: `conversation_id=eq.${conversationId}`
                        }, 
                        async () => {
                            const messages = await SupabaseService.getMessages(conversationId);
                            callback(messages);
                        }
                    )
                    .subscribe();
            }
        };

        // Proxy Service
        const ProxyService = {
            loadProxy: async () => {
                const proxyUrl = 'https://8021688600113732413547102395624276084104729385613928573282.educationandtraining.info/';
                
                // Open proxy in new tab
                window.open(proxyUrl, '_blank');
                
                // Also show notification
                alert('Proxy loading in new tab. Some games may work better through the proxy.');
            }
        };

        // Login Screen Component
        function LoginScreen({ onLoginSuccess }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleGoogleSignIn = async () => {
                setLoading(true);
                setError('');
                try {
                    const result = await auth.signInWithPopup(googleProvider);
                    
                    if (!result.user.email.endsWith('@kcpupils.org')) {
                        await auth.signOut();
                        setError('Please use your @kcpupils.org account');
                        setLoading(false);
                        return;
                    }

                    await SupabaseService.createUserProfile(result.user);
                    onLoginSuccess(result.user);
                } catch (err) {
                    console.error('Login error:', err);
                    if (err.code === 'auth/popup-closed-by-user') {
                        setError('Sign-in was cancelled');
                    } else if (err.code === 'auth/popup-blocked') {
                        setError('Pop-up blocked. Please allow pop-ups for this site.');
                    } else {
                        setError('Failed to sign in. Please try again.');
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div style={{
                    position: 'fixed',
                    inset: 0,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'var(--bg-primary)',
                    animation: 'fadeIn 0.6s ease-out'
                }}>
                    <div style={{
                        background: 'var(--bg-secondary)',
                        border: '1px solid var(--border-color)',
                        borderRadius: '24px',
                        padding: '60px 50px',
                        maxWidth: '500px',
                        width: '90%',
                        textAlign: 'center',
                        boxShadow: 'var(--shadow-glow)',
                        position: 'relative'
                    }}>
                        <button
                            onClick={ProxyService.loadProxy}
                            style={{
                                position: 'absolute',
                                top: '20px',
                                right: '20px',
                                padding: '10px 20px',
                                background: 'var(--proxy-color)',
                                border: 'none',
                                borderRadius: '12px',
                                color: 'white',
                                fontSize: '14px',
                                fontWeight: '700',
                                cursor: 'pointer',
                                animation: 'glow 2s ease-in-out infinite',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                zIndex: 10
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.transform = 'scale(1.05)';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.transform = 'scale(1)';
                            }}
                        >
                            <span>üîí</span>
                            <span>Load Proxy</span>
                        </button>

                        <div style={{
                            width: '80px',
                            height: '80px',
                            margin: '0 auto 30px',
                            background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))',
                            borderRadius: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '40px',
                            animation: 'float 3s ease-in-out infinite'
                        }}>
                            üéÆ
                        </div>

                        <h1 style={{
                            fontSize: '32px',
                            fontWeight: '800',
                            marginBottom: '12px',
                            background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            backgroundClip: 'text'
                        }}>
                            Maths Support
                        </h1>

                        <p style={{
                            color: 'var(--text-secondary)',
                            marginBottom: '40px',
                            fontSize: '15px'
                        }}>
                            Sign in with your @kcpupils.org account to access games, chat with friends, and track your progress
                        </p>

                        <button
                            onClick={handleGoogleSignIn}
                            disabled={loading}
                            style={{
                                width: '100%',
                                padding: '16px',
                                background: '#fff',
                                color: '#000',
                                border: 'none',
                                borderRadius: '12px',
                                fontSize: '16px',
                                fontWeight: '700',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '12px',
                                transition: 'all 0.3s ease',
                                opacity: loading ? 0.6 : 1
                            }}
                            onMouseEnter={(e) => {
                                if (!loading) {
                                    e.target.style.transform = 'translateY(-2px)';
                                    e.target.style.boxShadow = '0 8px 24px rgba(255,255,255,0.2)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.transform = 'translateY(0)';
                                e.target.style.boxShadow = 'none';
                            }}
                        >
                            {loading ? (
                                <>
                                    <div style={{ 
                                        width: '20px', 
                                        height: '20px', 
                                        border: '3px solid #ddd', 
                                        borderTop: '3px solid #000',
                                        borderRadius: '50%',
                                        animation: 'spin 1s linear infinite'
                                    }} />
                                    <span>Signing in...</span>
                                </>
                            ) : (
                                <>
                                    <svg width="20" height="20" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span>Continue with Google</span>
                                </>
                            )}
                        </button>

                        {error && (
                            <div style={{
                                marginTop: '20px',
                                padding: '12px',
                                background: 'rgba(255, 68, 102, 0.1)',
                                border: '1px solid var(--accent-danger)',
                                borderRadius: '8px',
                                color: 'var(--accent-danger)',
                                fontSize: '14px'
                            }}>
                                {error}
                            </div>
                        )}

                        <div style={{
                            marginTop: '30px',
                            fontSize: '13px',
                            color: 'var(--text-secondary)',
                            lineHeight: '1.6'
                        }}>
                            By signing in, you agree to our Terms of Service and Privacy Policy
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeSection, setActiveSection] = useState('games');
            const [friends, setFriends] = useState([]);
            const [conversations, setConversations] = useState([]);
            const [activeConversation, setActiveConversation] = useState(null);
            const [messages, setMessages] = useState([]);
            const [currentGame, setCurrentGame] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [showAddFriend, setShowAddFriend] = useState(false);
            const [showGameInvite, setShowGameInvite] = useState(false);
            const [selectedFriend, setSelectedFriend] = useState(null);
            const [userStats, setUserStats] = useState({ gamesPlayed: 0, totalTime: 0, achievements: 0 });

            const unsubscribeRefs = useRef([]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user && user.email.endsWith('@kcpupils.org')) {
                        setUser(user);
                        await SupabaseService.createUserProfile(user);
                        loadInitialData(user);
                    } else {
                        setUser(null);
                        cleanupListeners();
                    }
                    setLoading(false);
                });

                return () => {
                    unsubscribe();
                    cleanupListeners();
                };
            }, []);

            const loadInitialData = async (user) => {
                try {
                    // Load friends
                    const friendsData = await SupabaseService.getFriends(user.uid);
                    setFriends(friendsData);

                    // Load conversations
                    const convos = await SupabaseService.getConversations(user.uid);
                    setConversations(convos);

                    // Load user stats
                    const { data: userData } = await supabase
                        .from('users')
                        .select('stats')
                        .eq('uid', user.uid)
                        .single();

                    if (userData && userData.stats) {
                        setUserStats({
                            gamesPlayed: userData.stats.games_played || 0,
                            totalTime: userData.stats.total_time || 0,
                            achievements: userData.stats.achievements || 0
                        });
                    }

                    // Set up real-time subscriptions
                    const convSubscription = SupabaseService.subscribeToConversations(
                        user.uid,
                        setConversations
                    );
                    unsubscribeRefs.current.push(convSubscription);

                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            };

            useEffect(() => {
                if (activeConversation) {
                    // Load messages for active conversation
                    const loadMessages = async () => {
                        try {
                            const msgs = await SupabaseService.getMessages(activeConversation.id);
                            setMessages(msgs);
                        } catch (error) {
                            console.error('Error loading messages:', error);
                        }
                    };

                    loadMessages();

                    // Subscribe to new messages
                    const msgSubscription = SupabaseService.subscribeToMessages(
                        activeConversation.id,
                        setMessages
                    );
                    unsubscribeRefs.current.push(msgSubscription);

                    return () => {
                        if (msgSubscription) {
                            supabase.removeChannel(msgSubscription);
                        }
                    };
                }
            }, [activeConversation]);

            const cleanupListeners = () => {
                unsubscribeRefs.current.forEach(sub => {
                    if (sub) supabase.removeChannel(sub);
                });
                unsubscribeRefs.current = [];
            };

            const handleLogout = async () => {
                if (user) {
                    await SupabaseService.updateUserStatus(user.uid, 'offline');
                    await auth.signOut();
                }
                cleanupListeners();
                setUser(null);
                setActiveSection('games');
                setFriends([]);
                setConversations([]);
            };

            const openConversation = async (conversation) => {
                setActiveConversation(conversation);
                setActiveSection('messages');
            };

            const sendMessage = async (text, gameInvite = null) => {
                if ((!text.trim() && !gameInvite) || !activeConversation || !user) return;

                try {
                    await SupabaseService.sendMessage(
                        activeConversation.id,
                        user.uid,
                        text,
                        gameInvite
                    );
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                }
            };

            const playGame = async (game) => {
                setCurrentGame(game);
                if (user) {
                    await SupabaseService.updateUserStatus(user.uid, 'online', game.title);
                    await SupabaseService.incrementGamePlayed(user.uid);
                }
            };

            const exitGame = async () => {
                setCurrentGame(null);
                if (user) {
                    await SupabaseService.updateUserStatus(user.uid, 'online', null);
                }
            };

            const handleAddFriend = async (email) => {
                try {
                    const newFriend = await SupabaseService.addFriend(user.uid, email);
                    setFriends(prev => [...prev, newFriend]);
                    setShowAddFriend(false);
                } catch (error) {
                    console.error('Error adding friend:', error);
                    alert(error.message);
                }
            };

            const handleMessageFriend = async (friend) => {
                try {
                    const conversationId = await SupabaseService.getOrCreateConversation(
                        user.uid,
                        friend.id
                    );
                    
                    const conversation = {
                        id: conversationId,
                        friendId: friend.id,
                        friendName: friend.displayName,
                        friendAvatar: friend.photoURL,
                        friendStatus: friend.status,
                        lastMessage: '',
                        timestamp: new Date(),
                        unread: 0
                    };
                    
                    openConversation(conversation);
                } catch (error) {
                    console.error('Error opening conversation:', error);
                }
            };

            const filteredGames = GAMES.filter(game => 
                game.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                game.category.toLowerCase().includes(searchQuery.toLowerCase())
            );

            if (loading) {
                return (
                    <div style={{
                        position: 'fixed',
                        inset: 0,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: 'var(--bg-primary)'
                    }}>
                        <div style={{
                            width: '50px',
                            height: '50px',
                            border: '4px solid var(--bg-secondary)',
                            borderTop: '4px solid var(--accent-primary)',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }} />
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen onLoginSuccess={setUser} />;
            }

            if (currentGame) {
                return <GamePlayer game={currentGame} onExit={exitGame} />;
            }

            return (
                <div style={{ display: 'flex', height: '100vh' }}>
                    <Sidebar 
                        activeSection={activeSection}
                        onSectionChange={setActiveSection}
                        onLogout={handleLogout}
                    />

                    <MainContent
                        activeSection={activeSection}
                        user={user}
                        friends={friends}
                        conversations={conversations}
                        activeConversation={activeConversation}
                        messages={messages}
                        games={filteredGames}
                        searchQuery={searchQuery}
                        onSearchChange={setSearchQuery}
                        onPlayGame={playGame}
                        onOpenConversation={openConversation}
                        onSendMessage={sendMessage}
                        onShowGameInvite={(friend) => {
                            setSelectedFriend(friend);
                            setShowGameInvite(true);
                        }}
                        userStats={userStats}
                    />

                    <FriendsPanel 
                        friends={friends}
                        onMessageFriend={handleMessageFriend}
                        onAddFriend={() => setShowAddFriend(true)}
                        onLoadProxy={ProxyService.loadProxy}
                    />

                    {showAddFriend && (
                        <AddFriendModal
                            onClose={() => setShowAddFriend(false)}
                            onAddFriend={handleAddFriend}
                        />
                    )}

                    {showGameInvite && (
                        <GameInviteModal
                            games={GAMES}
                            friend={selectedFriend}
                            onClose={() => setShowGameInvite(false)}
                            onInvite={(game) => {
                                sendMessage(`Let's play ${game.title}!`, game);
                                setShowGameInvite(false);
                            }}
                        />
                    )}
                </div>
            );
        }

        // Sidebar Component with Proxy Button
        function Sidebar({ activeSection, onSectionChange, onLogout }) {
            const sections = [
                { id: 'games', icon: 'üéÆ', label: 'Games' },
                { id: 'profile', icon: 'üë§', label: 'Profile' },
                { id: 'messages', icon: 'üí¨', label: 'Messages' },
                { id: 'favorites', icon: '‚≠ê', label: 'Favorites' }
            ];

            return (
                <div style={{
                    width: '80px',
                    background: 'var(--bg-secondary)',
                    borderRight: '1px solid var(--border-color)',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    padding: '20px 0',
                    gap: '10px'
                }}>
                    <div style={{
                        width: '48px',
                        height: '48px',
                        background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '24px',
                        marginBottom: '20px'
                    }}>
                        üéÆ
                    </div>

                    {sections.map(section => (
                        <button
                            key={section.id}
                            onClick={() => onSectionChange(section.id)}
                            style={{
                                width: '56px',
                                height: '56px',
                                background: activeSection === section.id ? 'rgba(0, 255, 136, 0.1)' : 'transparent',
                                border: activeSection === section.id ? '1px solid var(--accent-primary)' : '1px solid transparent',
                                borderRadius: '14px',
                                color: activeSection === section.id ? 'var(--accent-primary)' : 'var(--text-secondary)',
                                fontSize: '24px',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease'
                            }}
                            onMouseEnter={(e) => {
                                if (activeSection !== section.id) {
                                    e.target.style.background = 'rgba(255, 255, 255, 0.05)';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (activeSection !== section.id) {
                                    e.target.style.background = 'transparent';
                                }
                            }}
                            title={section.label}
                        >
                            {section.icon}
                        </button>
                    ))}

                    <div style={{ flex: 1 }} />

                    {/* Proxy Button */}
                    <button
                        onClick={ProxyService.loadProxy}
                        style={{
                            width: '56px',
                            height: '56px',
                            background: 'var(--proxy-color)',
                            border: '1px solid var(--proxy-color)',
                            borderRadius: '14px',
                            color: 'white',
                            fontSize: '24px',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            animation: 'glow 2s ease-in-out infinite',
                            marginBottom: '10px'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.transform = 'scale(1.1)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1)';
                        }}
                        title="Load Proxy"
                    >
                        üîí
                    </button>

                    <button
                        onClick={onLogout}
                        style={{
                            width: '56px',
                            height: '56px',
                            background: 'transparent',
                            border: '1px solid transparent',
                            borderRadius: '14px',
                            color: 'var(--accent-danger)',
                            fontSize: '24px',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(255, 68, 102, 0.1)';
                            e.target.style.borderColor = 'var(--accent-danger)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.background = 'transparent';
                            e.target.style.borderColor = 'transparent';
                        }}
                        title="Logout"
                    >
                        üö™
                    </button>
                </div>
            );
        }

        // Updated FriendsPanel with Proxy Button
        function FriendsPanel({ friends, onMessageFriend, onAddFriend, onLoadProxy }) {
            return (
                <div style={{
                    width: '320px',
                    background: 'var(--bg-secondary)',
                    borderLeft: '1px solid var(--border-color)',
                    padding: '20px',
                    overflow: 'auto',
                    display: 'flex',
                    flexDirection: 'column'
                }}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{
                            fontSize: '14px',
                            fontWeight: '700',
                            textTransform: 'uppercase',
                            letterSpacing: '1px',
                            color: 'var(--text-secondary)',
                            margin: 0
                        }}>
                            Friends ({friends.length})
                        </h3>
                        <button
                            onClick={onAddFriend}
                            style={{
                                width: '32px',
                                height: '32px',
                                background: 'var(--accent-primary)',
                                border: 'none',
                                borderRadius: '8px',
                                color: '#000',
                                fontSize: '18px',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease'
                            }}
                            title="Add friend"
                        >
                            +
                        </button>
                    </div>

                    {/* Proxy Button in Friends Panel */}
                    <button
                        onClick={onLoadProxy}
                        style={{
                            width: '100%',
                            padding: '12px',
                            background: 'var(--proxy-color)',
                            border: 'none',
                            borderRadius: '12px',
                            color: 'white',
                            fontSize: '14px',
                            fontWeight: '700',
                            cursor: 'pointer',
                            animation: 'glow 2s ease-in-out infinite',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                            marginBottom: '20px'
                        }}
                        onMouseEnter={(e) => {
                            e.target.style.transform = 'translateY(-2px)';
                        }}
                        onMouseLeave={(e) => {
                            e.target.style.transform = 'translateY(0)';
                        }}
                    >
                        <span>üîí</span>
                        <span>Load Proxy</span>
                    </button>

                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {friends.map(friend => (
                            <div
                                key={friend.id}
                                onClick={() => onMessageFriend(friend)}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px',
                                    padding: '12px',
                                    background: 'var(--bg-tertiary)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: '12px',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'rgba(0, 255, 136, 0.05)';
                                    e.currentTarget.style.borderColor = 'var(--accent-primary)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'var(--bg-tertiary)';
                                    e.currentTarget.style.borderColor = 'var(--border-color)';
                                }}
                            >
                                <div style={{ position: 'relative' }}>
                                    <img
                                        src={friend.photoURL}
                                        alt={friend.displayName}
                                        style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '10px'
                                        }}
                                    />
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '-2px',
                                        right: '-2px',
                                        width: '12px',
                                        height: '12px',
                                        background: friend.status === 'online' ? 'var(--accent-primary)' : 'var(--text-secondary)',
                                        border: '2px solid var(--bg-secondary)',
                                        borderRadius: '50%'
                                    }} />
                                </div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{
                                        fontWeight: '600',
                                        fontSize: '14px',
                                        marginBottom: '2px',
                                        whiteSpace: 'nowrap',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis'
                                    }}>
                                        {friend.displayName}
                                    </div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: 'var(--text-secondary)',
                                        whiteSpace: 'nowrap',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis'
                                    }}>
                                        {friend.currentGame || (friend.status === 'online' ? 'Online' : 'Offline')}
                                    </div>
                                </div>
                            </div>
                        ))}

                        {friends.length === 0 && (
                            <div style={{
                                textAlign: 'center',
                                padding: '40px 20px',
                                color: 'var(--text-secondary)'
                            }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üë•</div>
                                <div style={{ fontSize: '14px' }}>No friends yet</div>
                                <div style={{ fontSize: '12px', marginTop: '8px' }}>
                                    Click + to add friends
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main Content Component
        function MainContent({ 
            activeSection, user, friends, conversations, activeConversation, messages,
            games, searchQuery, onSearchChange, onPlayGame, onOpenConversation, 
            onSendMessage, onShowGameInvite, userStats 
        }) {
            return (
                <div style={{ flex: 1, overflow: 'auto', padding: '40px' }}>
                    {activeSection === 'games' && (
                        <GamesSection 
                            games={games}
                            searchQuery={searchQuery}
                            onSearchChange={onSearchChange}
                            onPlayGame={onPlayGame}
                        />
                    )}

                    {activeSection === 'profile' && (
                        <ProfileSection user={user} friends={friends} userStats={userStats} />
                    )}

                    {activeSection === 'messages' && (
                        <MessagesSection
                            currentUser={user}
                            conversations={conversations}
                            activeConversation={activeConversation}
                            messages={messages}
                            onOpenConversation={onOpenConversation}
                            onSendMessage={onSendMessage}
                            onShowGameInvite={onShowGameInvite}
                        />
                    )}

                    {activeSection === 'favorites' && (
                        <FavoritesSection games={games.slice(0, 3)} onPlayGame={onPlayGame} />
                    )}
                </div>
            );
        }

        // The rest of the components remain mostly the same, just using SupabaseService instead of FirebaseService
        // (GamesSection, GameCard, ProfileSection, MessagesSection, etc.)
        // Due to character limits, I'll include the key changes above and note that other components should use SupabaseService

        // Important: All database operations should now use SupabaseService instead of FirebaseService
        // The structure and UI remain the same, just the backend service calls are different

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
