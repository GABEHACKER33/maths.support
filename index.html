
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Support</title>
    <link rel="icon" href="maths-logo.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #4a6bff; --nav-w: 80px; --nav-hover: 220px; }
        
        body { 
            margin: 0; font-family: 'Rajdhani', sans-serif; 
            background: #0f0f13 url('https://i.postimg.cc/KzFQVCHM/Copilot-20251119-203242.png') no-repeat center center fixed;
            background-size: cover; color: #fff; overflow-x: hidden;
        }

        /* Overlay Discreto */
        #password-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px); z-index: 10000; display: flex;
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }
        .login-card {
            background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); text-align: center; width: 320px;
        }

        /* Side Nav Centrada */
        .side-nav {
            position: fixed; left: 0; top: 0; height: 100vh; width: var(--nav-w);
            background: rgba(15, 15, 20, 0.9); backdrop-filter: blur(10px);
            z-index: 100; display: flex; flex-direction: column; transition: 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .side-nav:hover { width: var(--nav-hover); }
        .nav-item {
            width: 100%; display: flex; align-items: center; padding: 18px 0;
            color: #ccc; text-decoration: none; transition: 0.2s;
        }
        .nav-item i { min-width: var(--nav-w); text-align: center; font-size: 20px; }
        .nav-item span { opacity: 0; white-space: nowrap; font-weight: 600; transition: 0.2s; }
        .side-nav:hover .nav-item span { opacity: 1; }
        .nav-item:hover { color: var(--primary); background: rgba(74, 107, 255, 0.1); }

        /* Grid Optimizado */
        .main-content { margin-left: var(--nav-w); padding: 30px; transition: 0.3s; }
        .content-locked { display: none; }
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 20px; max-width: 1400px; margin: 0 auto; 
        }
        .card { 
            background: #1a1a21; border-radius: 12px; overflow: hidden; height: 200px;
            position: relative; cursor: pointer; border: 1px solid #2d2d35;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(74, 107, 255, 0.3);
        }
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        .card-preview { width: 100%; height: 100%; object-fit: cover; transition: 0.4s; opacity: 0.8; }
        .card:hover .card-preview { transform: scale(1.05); opacity: 1; }
        .card-title {
            position: absolute; bottom: 30px; width: 100%; padding: 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            font-size: 14px; text-align: center; font-family: 'Orbitron';
        }
        .card-tag {
            position: absolute; bottom: 8px; width: 100%; 
            text-align: center; font-size: 11px; color: var(--primary);
            font-weight: 600; text-transform: uppercase;
        }



        /* Game Container */
        #game-container {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 20000;
            flex-direction: column;
        }
        #iframeContainer {
            flex: 1;
            position: relative;
        }
        #gameIframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #control-buttons {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.9);
            justify-content: center;
        }
        .control-btn {
            background: rgba(74, 107, 255, 0.8);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 14px;
            transition: 0.3s;
        }
        .control-btn:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>

<div id="password-overlay">
    <div class="login-card">
        <img src="maths-logo.png" width="80" id="main-logo" style="margin-bottom:20px;">
        <h2 style="font-family:'Orbitron'; font-size:18px;">MATHS SUPPORT</h2>
        <p style="font-size:13px; color:#aaa; margin-bottom:25px;">Usa tu cuenta de kcpupils.org</p>
        <button class="google-btn" id="login-google">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
            Sign in with Google
        </button>
        <div id="status-msg" style="margin-top:15px; font-size:12px; color:#ff4a6b;"></div>
    </div>
</div>

<div id="main-site-content" class="content-locked">
    <canvas id="snow-canvas"></canvas>
    <div class="side-nav">
        <div style="padding: 20px; text-align: center;">
            <img src="maths-logo.png" width="40">
        </div>
        <a href="#" class="nav-item"><i class="fas fa-th-large"></i><span>Library</span></a>
        <a href="#" class="nav-item"><i class="fas fa-star"></i><span>Favorites</span></a>
        <div style="margin-top:auto">
            <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
        </div>
    </div>

    <div class="main-content">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="font-family:'Orbitron'; font-size:22px; margin:0">GAMES</h1>
            <input type="text" id="gameSearch" placeholder="Search games..." style="background:#1a1a21; border:1px solid #333; color:#fff; padding:10px 20px; border-radius:20px; width:300px;">
        </header>

        <div class="grid" id="game-grid">
            <div class="card" data-search="drive mad car racing vehicle"
                onclick="openGame('https://games.playtropolis.com/drive-mad-v2/', 'Drive Mad')">
                <img class="card-preview" src="img/drive-mad.png" loading="lazy">
                <div class="card-title">Drive Mad</div>
                <div class="card-tag">Racing</div>
            </div>

            <div class="card" data-search="poly track racing car vehicle"
                onclick="openGame('https://arcadrome.com/embed/polytrack', 'Poly Track')">
                <img class="card-preview" src="img/polytrack.png" loading="lazy">
                <div class="card-title">Poly Track</div>
                <div class="card-tag">Racing</div>
            </div>

            <div class="card" data-search="odd bot out robot puzzle"
                onclick="openGame('https://games.playtropolis.com/odd-bot-out/', 'Odd Bot Out')">
                <img class="card-preview" src="img/odd-bot-out.png" loading="lazy">
                <div class="card-title">Odd Bot Out</div>
                <div class="card-tag">Puzzle</div>
            </div>

            <div class="card" data-search="stunt bike extreme motorcycle tricks"
                onclick="openGame('https://games.playtropolis.com/stunt-bike-extreme/', 'Stunt Bike Extreme')">
                <img class="card-preview" src="img/stunt-bike-extreme.png" loading="lazy">
                <div class="card-title">Stunt Bike Extreme</div>
                <div class="card-tag">Sports</div>
            </div>

            <div class="card" data-search="subway surfers running endless"
                onclick="openGame('https://arcadrome.com/embed/subway-surfers', 'Subway Surfers')">
                <img class="card-preview" src="img/subway-surfers.png" loading="lazy">
                <div class="card-title">Subway Surfers</div>
                <div class="card-tag">Endless</div>
            </div>

            <div class="card" data-search="monkey mart store management"
                onclick="openGame('https://games.playtropolis.com/monkey-mart/', 'Monkey Mart')">
                <img class="card-preview" src="img/monkey-markt.png" loading="lazy">
                <div class="card-title">Monkey Mart</div>
                <div class="card-tag">Management</div>
            </div>

            <div class="card" data-search="house of hazards obstacle fun"
                onclick="openGame('https://games.playtropolis.com/house-of-hazards/', 'House Of Hazards')">
                <img class="card-preview" src="img/house-of-hazards.png" loading="lazy">
                <div class="card-title">House Of Hazards</div>
                <div class="card-tag">Fun</div>
            </div>

            <div class="card" data-search="tiny fishing fish ocean"
                onclick="openGame('https://games.playtropolis.com/tiny-fishing/', 'Tiny Fishing')">
                <img class="card-preview" src="img/tiny-fishing.png" loading="lazy">
                <div class="card-title">Tiny Fishing</div>
                <div class="card-tag">Casual</div>
            </div>

            <div class="card" data-search="Basketball Legends"
                onclick="openGame('https://games.playtropolis.com/basketball-stars/', 'Basketball Legends')">
                <img class="card-preview" src="img/basketball-legends.png" loading="lazy">
                <div class="card-title">Basketball Legends</div>
                <div class="card-tag">Sports</div>
            </div>

            <div class="card" data-search="short life"
                onclick="openGame('https://games.playtropolis.com/short-life/', 'Short Life')">
                <img class="card-preview" src="img/short-life.png" loading="lazy">
                <div class="card-title">Short Life</div>
                <div class="card-tag">Fun</div>
            </div>

            <div class="card" data-search="super tiny market"
                onclick="openGame('https://games.playtropolis.com/my-super-tiny-market/', 'My Super Tiny Market')">
                <img class="card-preview" src="img/my-super-tiny-market.png" loading="lazy">
                <div class="card-title">My Super Tiny Market</div>
                <div class="card-tag">Management</div>
            </div>

            <div class="card" data-search="car chase"
                onclick="openGame('https://idev.games/embed/car-chase-', 'Car Chase')">
                <img class="card-preview" src="img/car-chase.png" loading="lazy">
                <div class="card-title">Car Chase</div>
                <div class="card-tag">Action</div>
            </div>

            <div class="card" data-search="minecraft"
                onclick="openGame('https://x.mess.eu.org/ninja-wasm/', 'Minecraft')">
                <img class="card-preview" src="img/minecraft.png" loading="lazy">
                <div class="card-title">Minecraft</div>
                <div class="card-tag">Casual</div>
            </div>

            <div class="card" data-search="Amazing Rope Police"
                onclick="openGame('https://ezclasswork.com/science/amazing-rope-police/', 'Amazing Rope Police')">
                <img class="card-preview" src="img/amazing-rope-police.png" loading="lazy">
                <div class="card-title">Amazing Rope Police</div>
                <div class="card-tag">Action</div>
            </div>

            <div class="card" data-search="Shell Shockers"
                onclick="openGame('https://geometry.pw/', 'Shell Shockers')">
                <img class="card-preview" src="img/shell-shockers.png" loading="lazy">
                <div class="card-title">Shell Shockers</div>
                <div class="card-tag">Shooter</div>
            </div>

            <div class="card" data-search="Recoil"
                onclick="openGame('https://games.playtropolis.com/recoil/', 'Recoil')">
                <img class="card-preview" src="img/recoil.png" loading="lazy">
                <div class="card-title">Recoil</div>
                <div class="card-tag">Action</div>
            </div>

            <div class="card" data-search="Smash Karts"
                onclick="openGame('https://geometrykarts.com/', 'Smash Karts')">
                <img class="card-preview" src="img/smash-karts.png" loading="lazy">
                <div class="card-title">Smash Karts</div>
                <div class="card-tag">Racing</div>
            </div>

            <div class="card" data-search="Rocket Bot Royale"
                onclick="openGame('https://rocket-bot-royale.gabriel-oli-ren-micro.workers.dev/', 'Rocket Bot Royale')">
                <img class="card-preview" src="img/rocket-bot-royale.png" loading="lazy">
                <div class="card-title">Rocket Bot Royale</div>
                <div class="card-tag">Battle</div>
            </div>

            <div class="card" data-search="Goober Dash"
                onclick="openGame('https://goober-dash.gabriel-oli-ren-micro.workers.dev/', 'Goober Dash')">
                <img class="card-preview" src="img/goober-dash.png" loading="lazy">
                <div class="card-title">Goober Dash</div>
                <div class="card-tag">Fun</div>
            </div>

            <div class="card" data-search="Rooftop Snipers"
                onclick="openGame('https://ezclasswork.com/science/rooftop-snipers-2/', 'Rooftop Snipers')">
                <img class="card-preview" src="img/rooftop-snipers.png" loading="lazy">
                <div class="card-title">Rooftop Snipers</div>
                <div class="card-tag">Shooter</div>
            </div>

            <div class="card disabled" data-search="Cookie Clicker">
                <img class="card-preview" src="img/cookie-clicker.png" loading="lazy">
                <div class="card-title">Cookie Clicker</div>
                <div class="card-tag">Disabled</div>
            </div>

            <div class="card disabled" data-search="Snow Rider">
                <img class="card-preview" src="img/snow-rider.png" loading="lazy">
                <div class="card-title">Snow Rider</div>
                <div class="card-tag">Disabled</div>
            </div>

            <div class="card" data-search="Masked Special Forces"
                onclick="openGame('https://ezclasswork.com/science/maskedforces/', 'Masked Special Forces')">
                <img class="card-preview" src="img/masked-forces.png" loading="lazy">
                <div class="card-title">Masked Special Forces</div>
                <div class="card-tag">Action</div>
            </div>

            <div class="card" data-search="ROYALEDLE"
                onclick="openGame('https://clash.gabriel-oli-ren-micro.workers.dev/', 'ROYALEDLE')">
                <img class="card-preview" src="img/royaledle.png" loading="lazy">
                <div class="card-title">ROYALEDLE</div>
                <div class="card-tag">Puzzle</div>
            </div>
            
            <div class="card" data-search="Sound Buttons"
                onclick="openGame('https://myinstants.online/', 'Sound Buttons')">
                <img class="card-preview" src="img/my-instants.png" loading="lazy">
                <div class="card-title">Sound Buttons</div>
                <div class="card-tag">Fun</div>
            </div>    
            
            <div class="card" data-search="EzClasswork"
                onclick="openGame('https://ezclasswork.com/', 'EzClasswork')">
                <img class="card-preview" src="img/ez.png" loading="lazy">
                <div class="card-title">EzClasswork</div>
                <div class="card-tag">Portal</div>
            </div>   
            
            <div class="card" data-search="Rtve Play"
                onclick="openGame('https://rtve.es/play/', 'Rtve Play')">
                <img class="card-preview" src="img/rt-ve.png" loading="lazy">
                <div class="card-title">Rtve Play</div>
                <div class="card-tag">Video</div>
            </div>
        </div>
    </div>
</div>

<div id="game-container">
    <div id="iframeContainer">
        <iframe id="gameIframe" src="" allowfullscreen allow="autoplay; fullscreen"></iframe>
    </div>
    <div id="control-buttons">
        <button class="control-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i> Fullscreen</button>
        <button class="control-btn" onclick="closeGame()"><i class="fas fa-times"></i> Exit</button>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://hsmfjpetvcsgkpkwpdjr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzbWZqcGV0dmNzZ2twa3dwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDc0MzEsImV4cCI6MjA3OTMyMzQzMX0.IBiJtUJBPyjNwGowfgnlfrbHpb46C43NmYY3O9rEFqQ';
const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// VerificaciÃ³n Discreta
async function checkUser(user) {
    if (!user.email.endsWith('@kcpupils.org')) {
        document.getElementById('status-msg').innerText = "Only @kcpupils.org accounts allowed.";
        await _sb.auth.signOut();
        return false;
    }

    const { data } = await _sb.from('user_access').select('is_banned').eq('email', user.email).single();
    if (data?.is_banned) {
        document.getElementById('status-msg').innerText = "Authentication failed. Try again later.";
        await _sb.auth.signOut();
        return false;
    }
    return true;
}

async function init() {
    const { data: { session } } = await _sb.auth.getSession();
    if (session) {
        if (await checkUser(session.user)) unlock();
    }
}

function unlock() {
    document.getElementById('password-overlay').style.display = 'none';
    document.getElementById('main-site-content').classList.remove('content-locked');
}

document.getElementById('login-google').onclick = () => _sb.auth.signInWithOAuth({ provider: 'google' });

function logout() { _sb.auth.signOut().then(() => location.reload()); }

function openGame(url, title) {
    document.getElementById('gameIframe').src = url;
    document.getElementById('game-container').style.display = 'flex';
    document.title = title + ' - Maths Support';
}

function closeGame() {
    document.getElementById('game-container').style.display = 'none';
    document.getElementById('gameIframe').src = '';
    document.title = 'Maths Support';
}

function toggleFullscreen() {
    const iframe = document.getElementById('iframeContainer');
    if (!document.fullscreenElement) {
        iframe.requestFullscreen().catch(err => {
            console.log('Fullscreen error:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

// Buscador
document.getElementById('gameSearch').oninput = (e) => {
    const val = e.target.value.toLowerCase();
    document.querySelectorAll('.card').forEach(c => {
        const searchText = c.getAttribute('data-search') || '';
        c.style.display = searchText.includes(val) ? 'block' : 'none';
    });
};

// Nieve Optimizada (Baja carga de CPU)
const canvas = document.getElementById('snow-canvas');
const ctx = canvas.getContext('2d');
let flakes = Array.from({length: 40}, () => ({ x: Math.random(), y: Math.random(), r: Math.random() * 2 + 1, s: Math.random() * 0.002 + 0.001 }));

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.3)";
    flakes.forEach(f => {
        ctx.beginPath(); ctx.arc(f.x * canvas.width, f.y * canvas.height, f.r, 0, Math.PI*2); ctx.fill();
        f.y += f.s; if (f.y > 1) f.y = 0;
    });
    requestAnimationFrame(draw);
}
draw();
init();
</script>
</body>
</html>
